# SQLAlchemy Development Guidelines

> Objective: Define standards for using SQLAlchemy safely and efficiently in Python applications.

## 1. Engine & Session Setup

- Create a single `Engine` instance per application and reuse it. Configure the connection pool explicitly:
  ```python
  engine = create_engine(DATABASE_URL, pool_size=10, max_overflow=20, pool_pre_ping=True)
  ```
- Use `pool_pre_ping=True` to automatically handle stale connections.
- Use `sessionmaker` to create a `Session` factory. Manage session lifecycle with a context manager or dependency injection — never share sessions across threads or requests.
- In FastAPI/web frameworks, use a **per-request session** via a dependency (`get_db` pattern) and always close the session after the request.

## 2. ORM Models (Declarative)

- Define all models using the **Declarative Base** (SQLAlchemy 2.x: `DeclarativeBase`).
- Use **typed annotations** (`Mapped[int]`, `Mapped[str]`, `mapped_column()`) from SQLAlchemy 2.x for full type safety.
- Always define `__tablename__` explicitly. Use `snake_case` for table and column names.
- Add `created_at: Mapped[datetime] = mapped_column(default=func.now())` and `updated_at` to all models.

## 3. Querying (SQLAlchemy 2.x Style)

- Use the **2.x `select()` style** for all queries: `session.execute(select(User).where(User.id == user_id))`. Avoid the legacy `session.query()` API.
- Use `scalars()` to retrieve ORM objects: `session.scalars(select(User)).all()`.
- Use **`joinedload()`** or **`selectinload()`** for eager loading relationships to prevent N+1 queries. Avoid `lazy="dynamic"` relationships.
- Never interpolate user input into SQL strings. Use bound parameters: `text("WHERE name = :name").bindparams(name=user_input)`.

## 4. Transactions

- Sessions operate in a transaction by default. Use `session.commit()` to persist and `session.rollback()` to revert.
- Use `session.begin()` as a context manager for explicit transaction boundaries.
- Never call `session.commit()` inside a loop — batch writes and commit once.

## 5. Migrations

- Use **Alembic** for all schema migrations. Generate migration scripts with `alembic revision --autogenerate -m "description"`.
- Review autogenerated migrations carefully before applying — autogenerate is not perfect.
- Run `alembic upgrade head` in CI/CD pipelines before starting the application.
- Commit all migration files to version control.
