---
name: GitHub Actions Lint

"on":
  push:
    branches:
      - "main"
      - "dev"
      - "feat/**"
      - "branch/**"
      - "feature/**"
      - "fix/**"
      - "pr/**"
  pull_request:
    branches:
      - "main"
      - "dev"
      - "feat/**"
      - "branch/**"
      - "feature/**"
      - "fix/**"
      - "pr/**"
  workflow_dispatch:

jobs:
  lint:
    name: Run Linter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6.0.2
        with:
          # [Required] Access token with `workflow` scope.
          token: ${{ secrets.WORKFLOW_SECRET }}

      - name: Install Gitleaks
        shell: bash
        env:
          GITHUB_PROXY: ${{ secrets.GITHUB_PROXY || vars.GH_PROXY || 'https://gh-proxy.sn0wdr1am.com/' }}
        run: |
          OS=$(uname -s | tr '[:upper:]' '[:lower:]')
          ARCH=$(uname -m)

          if [ "$OS" = "darwin" ]; then
            GL_OS="darwin"
          elif [ "$OS" = "linux" ]; then
            GL_OS="linux"
          elif [[ "$OS" == *"mingw"* || "$OS" == *"msys"* || "$OS" == *"cygwin"* ]]; then
            GL_OS="windows"
          else
            echo "Unsupported OS: $OS"
            exit 1
          fi

          if [ "$ARCH" = "x86_64" ] || [ "$ARCH" = "amd64" ]; then
            GL_ARCH="x64"
          elif [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then
            GL_ARCH="arm64"
          elif [ "$ARCH" = "i386" ] || [ "$ARCH" = "i686" ]; then
            GL_ARCH="x32"
          else
            echo "Unsupported Architecture: $ARCH"
            exit 1
          fi

          echo "Detected OS: $GL_OS, Architecture: $GL_ARCH"
          GITLEAKS_VERSION=$(curl -s "https://api.github.com/repos/gitleaks/gitleaks/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          GITLEAKS_VERSION_NUM=${GITLEAKS_VERSION#v}
          echo "Latest Gitleaks version: $GITLEAKS_VERSION"

          if [ "$GL_OS" = "windows" ]; then
            GL_ARCHIVE="gitleaks_${GITLEAKS_VERSION_NUM}_${GL_OS}_${GL_ARCH}.zip"
            GL_URL="${GITHUB_PROXY}https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/${GL_ARCHIVE}"
            echo "Downloading $GL_URL"
            curl -sSL -o gitleaks.zip "$GL_URL"
            unzip gitleaks.zip -d gitleaks-bin
          else
            GL_ARCHIVE="gitleaks_${GITLEAKS_VERSION_NUM}_${GL_OS}_${GL_ARCH}.tar.gz"
            GL_URL="${GITHUB_PROXY}https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/${GL_ARCHIVE}"
            echo "Downloading $GL_URL"
            mkdir -p gitleaks-bin
            curl -sSL "$GL_URL" | tar -xz -C gitleaks-bin gitleaks
          fi

          chmod +x gitleaks-bin/gitleaks*
          echo "$PWD/gitleaks-bin" >> "$GITHUB_PATH"

      - name: Run Gitleaks
        shell: bash
        run: gitleaks detect --source . --verbose

      - name: Set env variables
        run: |
          {
            echo "BRANCH=${GITHUB_REF##*/}"
            echo "http_proxy=${http_proxy}"
            echo "no_proxy=${no_proxy}"
          } >> "$GITHUB_ENV"

      - name: Set up Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: "3.12"

      # Set up standard Python virtual environment
      - name: Setup Virtual Environment
        run: |
          python3 -m venv .venv
          source .venv/bin/activate

      # Installing linting packages into our venv
      - name: Install Linters
        run: |
          source .venv/bin/activate
          pip install yamllint ansible-lint ruff

      # Run yaml linting
      - name: Run yamllint
        run: |
          source .venv/bin/activate
          yamllint .

      # Setup Node.js for Markdown linting & JS-based tools
      - name: Set up Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: "20"

      - name: Install Node.js Linters
        run: npm install -g markdownlint-cli2 prettier editorconfig-checker cspell eslint

      - name: Install ShellCheck Binary
        env:
          GITHUB_PROXY: ${{ secrets.GITHUB_PROXY || vars.GH_PROXY || 'https://gh-proxy.sn0wdr1am.com/' }}
        run: |
          latest_version=$(curl -s "https://api.github.com/repos/koalaman/shellcheck/releases/latest" | grep -o '"tag_name"[[:space:]]*:[[:space:]]*"[^"]*"' | awk -F'"' '{print $4}')
          os_name=$(uname -s | tr '[:upper:]' '[:lower:]')
          arch_name=$(uname -m)

          if [ "$os_name" = "darwin" ]; then
            sc_os="darwin"
          elif [ "$os_name" = "linux" ]; then
            sc_os="linux"
          else
            echo "Unsupported OS: $os_name"
            exit 1
          fi

          if [ "$arch_name" = "x86_64" ] || [ "$arch_name" = "amd64" ]; then
            sc_arch="x86_64"
          elif [ "$arch_name" = "aarch64" ] || [ "$arch_name" = "arm64" ]; then
            sc_arch="aarch64"
          else
            echo "Unsupported Architecture: $arch_name"
            exit 1
          fi

          sc_url="${GITHUB_PROXY}https://github.com/koalaman/shellcheck/releases/download/${latest_version}/shellcheck-${latest_version}.${sc_os}.${sc_arch}.tar.gz"
          echo "Downloading ShellCheck ${latest_version} from $sc_url"
          curl -fLo sc.tar.gz --retry 3 "$sc_url"
          mkdir -p shellcheck-latest
          tar -xzf sc.tar.gz -C shellcheck-latest --strip-components=1
          echo "$PWD/shellcheck-latest" >> "$GITHUB_PATH"

      # Run Markdown linting (exclusions are handled by .markdownlintignore)
      - name: Run markdownlint
        run: npx markdownlint-cli2

      # Core Ansible Linting phase
      - name: Run ansible-lint
        run: |
          source .venv/bin/activate
          ansible-lint -v

      # Ansible Playbook syntax validation
      # NOTE: continue-on-error until all roles (home, orchestrator) are implemented
      - name: Run ansible-playbook syntax-check
        continue-on-error: true
        run: |
          source .venv/bin/activate
          if [ -d playbooks ]; then
            find playbooks -name "*.yml" -print0 | xargs -0 -I{} ansible-playbook --syntax-check {}
          else
            echo "No playbooks/ directory found, skipping syntax-check."
          fi

      # Python Linting (Ruff)
      - name: Run Ruff
        run: |
          source .venv/bin/activate
          if [ -n "$(find . -name '*.py' -print -quit)" ]; then
            ruff check .
            ruff format --check .
          else
            echo "No Python files found, skipping ruff."
          fi

      # JSON, YAML, Vue, JS, TS, & React formatting linting
      - name: Run Prettier
        run: npx prettier --check "**/*.{json,yml,yaml,vue,js,jsx,ts,tsx}"

      - name: Run editorconfig-checker
        run: npx editorconfig-checker -exclude "(\.(venv|git|github/agents|agent|agents|roo|claude|qwen|amazonq|augment|bob|codebuddy|codex|kilocode|opencode|qoder|shai|cursor|windsurf|pearai|pi|pochi|specify|supermaven|tabnine|trae|vibe|void|zed|zencoder|openhands|cody|coderabbit|aide|cline|clinerules|cursorrules|pr_agent.toml|tabnine|supermaven|vibe|void|zed)/.*)|((node_modules|venv|env|dist|build|out|target|vendor|__pycache__|\.specify/scripts)/.*)|(\.aider\.conf\.yml)"

      # Run Spell Checker (CSpell)
      # NOTE: continue-on-error can be removed once a custom dictionary is fully configured
      - name: Run CSpell (Spell Checker)
        continue-on-error: true
        run: npx cspell "**" --no-progress --no-summary --dot

      # JavaScript / TypeScript linting
      # Only runs if an ESLint configuration file is detected
      - name: Run ESLint
        run: |
          if [ -f "eslint.config.js" ] || [ -f "eslint.config.mjs" ] || [ -f ".eslintrc.js" ] || [ -f ".eslintrc.json" ]; then
            echo "ESLint config found, running ESLint..."
            npx eslint "."
          else
            echo "No ESLint configuration found, skipping ESLint."
          fi

      # Go Linting
      - name: Install GolangCI-Lint
        env:
          GITHUB_PROXY: ${{ secrets.GITHUB_PROXY || vars.GH_PROXY || 'https://gh-proxy.sn0wdr1am.com/' }}
        run: |
          mkdir -p ~/.local/bin
          curl -sSfL "${GITHUB_PROXY}https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh" | sh -s -- -b ~/.local/bin v1.56.2
          echo "$HOME/.local/bin" >> "$GITHUB_PATH"

      - name: Run golangci-lint
        run: |
          if [ -n "$(find . -name '*.go' -print -quit)" ]; then
            golangci-lint run
          else
            echo "No Go files found, skipping golangci-lint."
          fi

      # Rust Linting
      - name: Run Rustfmt and Clippy
        run: |
          if command -v cargo &> /dev/null && [ -f "Cargo.toml" ]; then
            echo "Cargo.toml found, running Rustfmt and Clippy..."
            cargo fmt -- --check
            cargo clippy -- -D warnings
          else
            echo "No Cargo.toml found or cargo not installed, skipping Rust linting."
          fi

      # Dart & Flutter Linting
      - name: Run Dart Format and Analyze
        run: |
          if command -v dart &> /dev/null; then
            if [ -n "$(find . -name '*.dart' -print -quit)" ]; then
              dart format --output=none --set-exit-if-changed .
              dart analyze --fatal-infos
            else
              echo "No Dart files found, skipping Dart linting."
            fi
          else
            echo "dart SDK not installed, skipping Dart linting."
          fi

      # Shell Scripts linting (excluding dependencies, running native binary)
      - name: Run ShellCheck
        run: |
          find . -type f -name "*.sh" -not -path "*/\.venv/*" -not -path "*/node_modules/*" -not -path "*/venv/*" -not -path "*/env/*" -not -path "*/dist/*" -not -path "*/build/*" -not -path "*/\.git/*" -not -path "*/\.specify/scripts/*" -exec bash -c 'shellcheck "$@"' _ {} +

      # Shell Scripts formatting (shfmt)
      - name: Run shfmt
        run: |
          sudo apt-get update && sudo apt-get install -y shfmt
          find . -type f -name "*.sh" -not -path "*/\.venv/*" -not -path "*/node_modules/*" -not -path "*/venv/*" -not -path "*/env/*" -not -path "*/dist/*" -not -path "*/build/*" -not -path "*/\.git/*" -not -path "*/\.specify/scripts/*" -exec shfmt -d {} +

      # PowerShell Scripts linting (using ubuntu runner's pre-installed pwsh)
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -ErrorAction Stop
          $scripts = Get-ChildItem -Path . -Recurse -Filter "*.ps1" | Where-Object { $_.FullName -notmatch '[/\\](\\.venv|node_modules|venv|env|dist|build|\\.git|\\.specify[/\\]scripts)[/\\]' }
          if ($null -eq $scripts -or @($scripts).Count -eq 0) {
            Write-Host "No PowerShell scripts found to analyze."
          } else {
            $hasError = $false
            foreach ($script in $scripts) {
              $results = Invoke-ScriptAnalyzer -Path $script.FullName
              if ($results) {
                $results | Format-Table -AutoSize
                $hasError = $true
              }
            }
            if ($hasError) {
              exit 1
            }
          }

      # GitHub Actions Workflows linting
      - name: Run actionlint
        env:
          GITHUB_PROXY: ${{ secrets.GITHUB_PROXY || vars.GH_PROXY || 'https://gh-proxy.sn0wdr1am.com/' }}
        run: |
          bash <(curl -s "${GITHUB_PROXY}https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash")
          ./actionlint

      # Dockerfile linting
      - name: Run hadolint
        run: |
          find . -type f -name "*Dockerfile*" -not -path "*/\.venv/*" -not -path "*/node_modules/*" -not -path "*/venv/*" -not -path "*/env/*" -not -path "*/dist/*" -not -path "*/build/*" -not -path "*/\.git/*" -not -path "*/\.specify/scripts/*" -print0 | while IFS= read -r -d '' file; do
            echo "Linting $file"
            docker run --rm -i hadolint/hadolint hadolint - < "$file"
          done
