---
name: GitHub Actions Lint

"on":
  push:
    branches:
      - "main"
      - "dev"
      - "feat/**"
      - "branch/**"
      - "feature/**"
      - "fix/**"
      - "pr/**"
  pull_request:
    branches:
      - "main"
      - "dev"
      - "feat/**"
      - "branch/**"
      - "feature/**"
      - "fix/**"
      - "pr/**"
  workflow_dispatch:

jobs:
  lint:
    name: Run Linter
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v6.0.2
        with:
          # [Required] Access token with `workflow` scope.
          token: ${{ secrets.WORKFLOW_SECRET }}

      - name: Set env variables
        run: |
          {
            echo "BRANCH=${GITHUB_REF##*/}"
            echo "http_proxy=${http_proxy}"
            echo "no_proxy=${no_proxy}"
          } >> "$GITHUB_ENV"

      - name: Set up Python
        uses: actions/setup-python@v6.2.0
        with:
          python-version: "3.12"

      # Set up standard Python virtual environment
      - name: Setup Virtual Environment
        run: |
          python3 -m venv .venv
          source .venv/bin/activate

      # Installing linting packages into our venv
      - name: Install Linters
        run: |
          source .venv/bin/activate
          pip install yamllint ansible-lint

      # Run yaml linting
      - name: Run yamllint
        run: |
          source .venv/bin/activate
          yamllint .

      # Setup Node.js for Markdown linting & JS-based tools
      - name: Set up Node.js
        uses: actions/setup-node@v6.2.0
        with:
          node-version: "20"

      - name: Install Node.js Linters
        run: npm install -g markdownlint-cli2 prettier editorconfig-checker shellcheck

      # Run Markdown linting (exclusions are handled by .markdownlintignore)
      - name: Run markdownlint
        run: npx markdownlint-cli2

      # Core Ansible Linting phase
      - name: Run ansible-lint
        run: |
          source .venv/bin/activate
          ansible-lint -v

      # JSON & General formatting linting
      - name: Run Prettier
        run: npx prettier --check "**/*.{json,yml,yaml}"

      - name: Run editorconfig-checker
        run: npx editorconfig-checker -exclude "(\.(venv|git|github/agents|agent|agents|roo|claude|qwen|amazonq|augment|bob|codebuddy|codex|kilocode|opencode|qoder|shai|cursor|windsurf|pearai|pi|pochi|specify|supermaven|tabnine|trae|vibe|void|zed|zencoder|openhands|cody|coderabbit|aide|cline|clinerules|cursorrules|pr_agent.toml|tabnine|supermaven|vibe|void|zed)/.*)|((node_modules|venv|env|dist|build|out|target|vendor|__pycache__|\.specify/scripts)/.*)|(\.aider\.conf\.yml)"

      # Shell Scripts linting (excluding dependencies, running via npx for runner-independence)
      - name: Run ShellCheck
        run: |
          find . -type f -name "*.sh" -not -path "*/\.venv/*" -not -path "*/node_modules/*" -not -path "*/venv/*" -not -path "*/env/*" -not -path "*/dist/*" -not -path "*/build/*" -not -path "*/\.git/*" -not -path "*/\.specify/scripts/*" -exec bash -c 'npx shellcheck "$@"' _ {} +

      # PowerShell Scripts linting (using ubuntu runner's pre-installed pwsh)
      - name: Run PSScriptAnalyzer
        shell: pwsh
        run: |
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force -ErrorAction Stop
          $scripts = Get-ChildItem -Path . -Recurse -Filter "*.ps1" | Where-Object { $_.FullName -notmatch '[/\\](\.venv|node_modules|venv|env|dist|build|\.git|\.specify[/\\]scripts)[/\\]' }
          if ($null -ne $scripts -and $scripts.Count -gt 0) {
            Invoke-ScriptAnalyzer -Path $scripts.FullName -EnableExit
          } else {
            Write-Host "No PowerShell scripts found to analyze."
          }

      # GitHub Actions Workflows linting
      - name: Run actionlint
        run: |
          sc_version="v0.10.0"
          sc_url="https://github.com/koalaman/shellcheck/releases/download/${sc_version}/shellcheck-${sc_version}.linux.x86_64.tar.xz"
          curl -L "$sc_url" | tar -xJ
          export PATH="$PWD/shellcheck-${sc_version}:$PATH"
          bash <(curl https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          ./actionlint

      # Dockerfile linting
      - name: Run hadolint
        run: |
          find . -type f -name "*Dockerfile*" -not -path "*/\.venv/*" -not -path "*/node_modules/*" -not -path "*/venv/*" -not -path "*/env/*" -not -path "*/dist/*" -not -path "*/build/*" -not -path "*/\.git/*" -not -path "*/\.specify/scripts/*" -print0 | while IFS= read -r -d '' file; do
            echo "Linting $file"
            docker run --rm -i hadolint/hadolint hadolint - < "$file"
          done
